<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Refeit√≥rio - Log Reader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }

        .status-dot.loaded {
            background: #2ed573;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .upload-area {
            width: 100%;
            padding: 30px;
            background: rgba(255,255,255,0.1);
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .upload-area:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            background: rgba(255,255,255,0.2);
            border-color: #4facfe;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .upload-text {
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .upload-subtext {
            font-size: 14px;
            opacity: 0.7;
        }

        .file-input {
            display: none;
        }

        .file-info {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .file-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .file-details {
            font-size: 14px;
            opacity: 0.8;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-icon {
            font-size: 40px;
            margin-bottom: 10px;
            display: block;
        }

        .card-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #fff;
        }

        .card-label {
            font-size: 14px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sensor-card {
            grid-column: 1 / -1;
            background: rgba(255,255,255,0.1);
        }

        .log {
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #fff;
        }

        .log-entry {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
            padding: 5px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }

        .reset-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, #ff6b6b 0%, #ee5a24 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.2s;
        }

        .reset-btn:hover {
            transform: translateY(-1px);
        }

        .reload-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s;
            display: none;
        }

        .reload-btn:hover {
            transform: translateY(-1px);
        }

        .error-msg {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }

        .success-msg {
            background: rgba(46, 213, 115, 0.2);
            border: 1px solid rgba(46, 213, 115, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Dashboard Refeit√≥rio</h1>
        </div>

        <div class="status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Aguardando arquivo de log</span>
        </div>

        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <span class="upload-icon">üìÅ</span>
            <div class="upload-text">Carregar Arquivo de Log</div>
            <div class="upload-subtext">Clique aqui ou arraste um arquivo .txt</div>
            <input type="file" id="fileInput" class="file-input" accept=".txt" onchange="handleFileSelect(event)">
        </div>

        <div id="fileInfo" class="file-info">
            <div class="file-name" id="fileName"></div>
            <div class="file-details" id="fileDetails"></div>
        </div>

        <div id="errorMsg" class="error-msg" style="display: none;"></div>
        <div id="successMsg" class="success-msg" style="display: none;"></div>

        <button class="reload-btn" id="reloadBtn" onclick="reloadFile()" style="display: none;">
            üîÑ Recarregar Arquivo
        </button>

        <div class="dashboard">
            <div class="card">
                <span class="card-icon">üë•</span>
                <div class="card-value" id="alunoCount">0</div>
                <div class="card-label">Alunos</div>
            </div>

            <div class="card">
                <span class="card-icon">ü•§</span>
                <div class="card-value" id="bebidaCount">0</div>
                <div class="card-label">Bebidas</div>
            </div>

            <div class="card">
                <span class="card-icon">üçΩÔ∏è</span>
                <div class="card-value" id="comidaCount">0</div>
                <div class="card-label">Comidas</div>
            </div>

            <div class="card sensor-card">
                <span class="card-icon">üìè</span>
                <div class="card-value" id="sensorValue">0 cm</div>
                <div class="card-label">Dist√¢ncia Sensor</div>
            </div>
        </div>

        <button class="reset-btn" onclick="resetCounters()">
            üîÑ Resetar Contadores
        </button>

        <div class="log">
            <div class="log-title">üìã Log de Atividades</div>
            <div id="logContainer"></div>
        </div>
    </div>

    <script>
        let currentFile = null;
        let isFileLoaded = false;
        let lastProcessedLine = '';

        // Dados do dashboard
        let dados = {
            sensor: 0,
            bebida: 0,
            comida: 0,
            aluno: 0
        };

        // Elementos DOM
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const uploadArea = document.getElementById('uploadArea');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileDetails = document.getElementById('fileDetails');
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        const reloadBtn = document.getElementById('reloadBtn');
        const logContainer = document.getElementById('logContainer');

        // Configura√ß√£o de drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // Manipula sele√ß√£o de arquivo
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // Processa o arquivo selecionado
        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.txt')) {
                showError('Por favor, selecione um arquivo .txt');
                return;
            }

            currentFile = file;
            showFileInfo(file);
            readFile(file);
        }

        // Mostra informa√ß√µes do arquivo
        function showFileInfo(file) {
            fileName.textContent = file.name;
            fileDetails.textContent = `Tamanho: ${(file.size / 1024).toFixed(2)} KB | Modificado: ${new Date(file.lastModified).toLocaleString()}`;
            fileInfo.style.display = 'block';
        }

        // L√™ o conte√∫do do arquivo
        function readFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    processLogContent(content);
                    updateFileStatus(true);
                    showSuccess('Arquivo carregado com sucesso!');
                    reloadBtn.style.display = 'block';
                } catch (error) {
                    console.error('Erro ao processar arquivo:', error);
                    showError('Erro ao processar o arquivo: ' + error.message);
                    updateFileStatus(false);
                }
            };

            reader.onerror = function() {
                showError('Erro ao ler o arquivo');
                updateFileStatus(false);
            };

            reader.readAsText(file);
        }

        // Processa o conte√∫do do log
        function processLogContent(content) {
            const lines = content.trim().split('\n');
            
            if (lines.length === 0) {
                throw new Error('Arquivo vazio');
            }

            // Pega a √∫ltima linha n√£o vazia
            let lastLine = '';
            for (let i = lines.length - 1; i >= 0; i--) {
                if (lines[i].trim()) {
                    lastLine = lines[i].trim();
                    break;
                }
            }

            if (!lastLine) {
                throw new Error('Nenhuma linha v√°lida encontrada');
            }

            // Verifica se √© uma nova linha
            if (lastLine === lastProcessedLine) {
                addLog('üìÑ Mesmos dados da √∫ltima leitura');
                return;
            }

            lastProcessedLine = lastLine;
            addLog('üìÑ Processando: ' + lastLine);

            // Tenta fazer parse do JSON
            try {
                const data = JSON.parse(lastLine);
                updateDashboardData(data);
                addLog('‚úÖ Dados atualizados com sucesso');
            } catch (jsonError) {
                // Se n√£o for JSON v√°lido, tenta extrair dados do formato texto
                parseTextFormat(lastLine);
            }
        }

        // Tenta extrair dados de formato texto alternativo
        function parseTextFormat(line) {
            // Procura por padr√µes como "sensor:10, bebida:5, comida:3, aluno:15"
            const patterns = {
                sensor: /sensor[:\s]*(\d+)/i,
                bebida: /bebida[:\s]*(\d+)/i,
                comida: /comida[:\s]*(\d+)/i,
                aluno: /aluno[:\s]*(\d+)/i
            };

            const extractedData = {};
            let foundData = false;

            for (const [key, pattern] of Object.entries(patterns)) {
                const match = line.match(pattern);
                if (match) {
                    extractedData[key] = parseInt(match[1]);
                    foundData = true;
                }
            }

            if (foundData) {
                updateDashboardData(extractedData);
                addLog('‚úÖ Dados extra√≠dos do formato texto');
            } else {
                throw new Error('Formato de dados n√£o reconhecido na linha: ' + line);
            }
        }

        // Atualiza os dados do dashboard
        function updateDashboardData(data) {
            // Atualiza apenas os campos presentes nos dados
            if (data.sensor !== undefined) dados.sensor = data.sensor;
            if (data.bebida !== undefined) dados.bebida = data.bebida;
            if (data.comida !== undefined) dados.comida = data.comida;
            if (data.aluno !== undefined) dados.aluno = data.aluno;

            updateDashboard();
        }

        // Atualiza o dashboard visual
        function updateDashboard() {
            document.getElementById('alunoCount').textContent = dados.aluno;
            document.getElementById('bebidaCount').textContent = dados.bebida;
            document.getElementById('comidaCount').textContent = dados.comida;
            document.getElementById('sensorValue').textContent = dados.sensor + ' cm';

            // Adiciona anima√ß√£o nos valores
            animateValue('alunoCount');
            animateValue('bebidaCount');
            animateValue('comidaCount');
            animateValue('sensorValue');
        }

        // Anima√ß√£o para valores atualizados
        function animateValue(elementId) {
            const element = document.getElementById(elementId);
            element.style.transform = 'scale(1.1)';
            element.style.transition = 'transform 0.2s';
            setTimeout(() => {
                element.style.transform = 'scale(1)';
            }, 200);
        }

        // Atualiza status do arquivo
        function updateFileStatus(loaded) {
            isFileLoaded = loaded;
            
            if (loaded) {
                statusDot.classList.add('loaded');
                statusText.textContent = 'Arquivo carregado';
            } else {
                statusDot.classList.remove('loaded');
                statusText.textContent = 'Erro no arquivo';
            }
        }

        // Recarrega o arquivo atual
        function reloadFile() {
            if (currentFile) {
                addLog('üîÑ Recarregando arquivo...');
                readFile(currentFile);
            }
        }

        // Reset dos contadores
        function resetCounters() {
            dados = { sensor: 0, bebida: 0, comida: 0, aluno: 0 };
            updateDashboard();
            addLog('üîÑ Contadores resetados');
        }

        // Adiciona entrada no log
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `${timestamp} - ${message}`;
            
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // Mant√©m apenas as √∫ltimas 20 entradas
            while (logContainer.children.length > 20) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Mostra mensagem de erro
        function showError(message) {
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            successMsg.style.display = 'none';
            setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 5000);
        }

        // Mostra mensagem de sucesso
        function showSuccess(message) {
            successMsg.textContent = message;
            successMsg.style.display = 'block';
            errorMsg.style.display = 'none';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 3000);
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            addLog('üì± Dashboard iniciado - Pronto para carregar arquivo');
            updateDashboard();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9842df351087128c',t:'MTc1ODcyMzA5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
