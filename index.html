<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Refeit√≥rio - Log Reader</title>
    <style>
        /* --- estilos mantidos iguais ao seu c√≥digo anterior --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
               background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
               min-height: 100vh; padding: 20px; color: white; }
        .container { max-width: 400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 28px; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .status { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px;
                  padding: 15px; background: rgba(255,255,255,0.1); border-radius: 15px; backdrop-filter: blur(10px);}
        .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #ff4757; animation: pulse 2s infinite; }
        .status-dot.loaded { background: #2ed573; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .upload-area { width: 100%; padding: 30px; background: rgba(255,255,255,0.1);
                       border: 2px dashed rgba(255,255,255,0.3); border-radius: 15px; text-align: center;
                       margin-bottom: 30px; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .upload-area:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.5); transform: translateY(-2px);}
        .upload-area.dragover { background: rgba(255,255,255,0.2); border-color: #4facfe; }
        .upload-icon { font-size: 48px; margin-bottom: 15px; display: block; }
        .upload-text { font-size: 16px; margin-bottom: 10px; font-weight: bold; }
        .upload-subtext { font-size: 14px; opacity: 0.7; }
        .file-input { display: none; }
        .file-info { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin-bottom: 20px; display: none; }
        .file-name { font-weight: bold; margin-bottom: 5px; }
        .file-details { font-size: 14px; opacity: 0.8; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .card { background: rgba(255,255,255,0.15); border-radius: 20px; padding: 20px; text-align: center;
                backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: transform 0.3s ease; }
        .card:hover { transform: translateY(-5px); }
        .card-icon { font-size: 40px; margin-bottom: 10px; display: block; }
        .card-value { font-size: 32px; font-weight: bold; margin-bottom: 5px; color: #fff; }
        .card-label { font-size: 14px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
        .sensor-card { grid-column: 1 / -1; background: rgba(255,255,255,0.1); }
        .log { background: rgba(0,0,0,0.2); border-radius: 15px; padding: 15px; max-height: 200px; overflow-y: auto; margin-top: 20px;}
        .log-title { font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #fff; }
        .log-entry { font-size: 12px; opacity: 0.8; margin-bottom: 5px; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 5px;}
        .reset-btn { width: 100%; padding: 12px; background: linear-gradient(45deg, #ff6b6b 0%, #ee5a24 100%);
                     border: none; border-radius: 10px; color: white; font-size: 14px; cursor: pointer; margin-top: 15px; transition: transform 0.2s;}
        .reset-btn:hover { transform: translateY(-1px); }
        .reload-btn { width: 100%; padding: 12px; background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
                      border: none; border-radius: 10px; color: white; font-size: 14px; cursor: pointer; margin-top: 10px; transition: transform 0.2s; display: none; }
        .reload-btn:hover { transform: translateY(-1px); }
        .error-msg { background: rgba(255, 107, 107, 0.2); border: 1px solid rgba(255, 107, 107, 0.5); border-radius: 10px; padding: 15px; margin: 10px 0; text-align: center;}
        .success-msg { background: rgba(46, 213, 115, 0.2); border: 1px solid rgba(46, 213, 115, 0.5); border-radius: 10px; padding: 15px; margin: 10px 0; text-align: center;}
        .drive-section { margin-bottom: 30px; text-align: center; }
        .drive-btn { width: 100%; padding: 15px; background: linear-gradient(45deg, #34a853 0%, #137333 100%);
                     border: none; border-radius: 15px; color: white; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: transform 0.2s;}
        .drive-btn:hover { transform: translateY(-2px); }
        .drive-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>üìä Dashboard Refeit√≥rio</h1></div>

        <div class="status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Aguardando arquivo de log</span>
        </div>

        <div class="drive-section">
            <button class="drive-btn" id="driveBtn" onclick="loadFromDrive()">‚òÅÔ∏è Carregar do Google Drive</button>
            <div class="drive-info"><small>Carrega o arquivo .txt mais recente da pasta configurada</small></div>
        </div>

        <div id="fileInfo" class="file-info">
            <div class="file-name" id="fileName"></div>
            <div class="file-details" id="fileDetails"></div>
        </div>

        <div class="dashboard">
            <div class="card"><span class="card-icon">üë•</span><div class="card-value" id="alunoCount">0</div><div class="card-label">Alunos</div></div>
            <div class="card"><span class="card-icon">ü•§</span><div class="card-value" id="bebidaCount">0</div><div class="card-label">Bebidas</div></div>
            <div class="card"><span class="card-icon">üçΩÔ∏è</span><div class="card-value" id="comidaCount">0</div><div class="card-label">Comidas</div></div>
            <div class="card sensor-card"><span class="card-icon">üìè</span><div class="card-value" id="sensorValue">0 cm</div><div class="card-label">Dist√¢ncia Sensor</div></div>
        </div>

        <button class="reset-btn" onclick="resetCounters()">üîÑ Resetar Contadores</button>

        <div class="log">
            <div class="log-title">üìã Log de Atividades</div>
            <div id="logContainer"></div>
        </div>
    </div>

    <script>
        let currentFile = null;
        let lastProcessedLine = '';
        let dados = { sensor: 0, bebida: 0, comida: 0, aluno: 0 };

        let driveConfig = {
            apiKey: "AIzaSyAunOmdlZSTPEdODMAjgHH8tuhKpsgBiU8",
            folderId: "1mWeTjv9EXj9J63u214uXKdv4sTVQ754p"
        };

        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const logContainer = document.getElementById('logContainer');
        const fileName = document.getElementById('fileName');
        const fileDetails = document.getElementById('fileDetails');
        const fileInfo = document.getElementById('fileInfo');

        // Atualiza status do arquivo
        function updateFileStatus(loaded) {
            if (loaded) { statusDot.classList.add('loaded'); statusText.textContent = 'Arquivo carregado'; }
            else { statusDot.classList.remove('loaded'); statusText.textContent = 'Erro no arquivo'; }
        }

        // Atualiza Dashboard
        function updateDashboardData(data) {
            if (data.sensor !== undefined) dados.sensor = data.sensor;
            if (data.bebida !== undefined) dados.bebida = data.bebida;
            if (data.comida !== undefined) dados.comida = data.comida;
            if (data.aluno !== undefined) dados.aluno = data.aluno;

            document.getElementById('alunoCount').textContent = dados.aluno;
            document.getElementById('bebidaCount').textContent = dados.bebida;
            document.getElementById('comidaCount').textContent = dados.comida;
            document.getElementById('sensorValue').textContent = dados.sensor + ' cm';
        }

        // Adiciona log visual
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `${timestamp} - ${message}`;
            logContainer.insertBefore(logEntry, logContainer.firstChild);
        }

        // Reset contadores
        function resetCounters() {
            dados = { sensor: 0, bebida: 0, comida: 0, aluno: 0 };
            updateDashboardData(dados);
            addLog('üîÑ Contadores resetados');
        }

        // Processa conte√∫do do arquivo
        function processLogContent(content) {
            const lines = content.trim().split('\n');
            if (lines.length === 0) throw new Error('Arquivo vazio');

            let validLine = '';
            for (let i = lines.length - 1; i >= 0; i--) {
                const line = lines[i].trim();
                if (!line) continue;
                if (line.includes('{') && line.includes('}')) { validLine = line; break; }
            }

            if (!validLine) throw new Error('Nenhuma linha JSON encontrada');

            if (validLine === lastProcessedLine) { addLog('üìÑ Mesmos dados da √∫ltima leitura'); return; }
            lastProcessedLine = validLine;

            const jsonStart = validLine.indexOf('{');
            const jsonEnd = validLine.lastIndexOf('}');
            const jsonPart = validLine.substring(jsonStart, jsonEnd + 1);

            try {
                const data = JSON.parse(jsonPart);
                updateDashboardData(data);
                addLog('‚úÖ Dados atualizados: ' + jsonPart);
            } catch (e) {
                addLog('‚ö†Ô∏è JSON inv√°lido: ' + jsonPart);
            }
        }

       async function loadFromDrive() {
    const driveBtn = document.getElementById('driveBtn');
    driveBtn.disabled = true;
    driveBtn.textContent = 'üîÑ Carregando...';
    try {
        const listUrl = `https://www.googleapis.com/drive/v3/files?q='${driveConfig.folderId}'+in+parents&orderBy=modifiedTime+desc&fields=files(id,name,modifiedTime,mimeType)&key=${driveConfig.apiKey}`;
        const res = await fetch(listUrl);
        const data = await res.json();
        if (!data.files || data.files.length === 0) throw new Error("Nenhum arquivo encontrado");

        // Filtra apenas arquivos .txt pelo nome
        const latestFile = data.files.find(f => f.name.toLowerCase().endsWith(".txt"));
        if (!latestFile) throw new Error("Nenhum arquivo .txt encontrado na pasta");

        addLog(`üìÑ Encontrado: ${latestFile.name}`);

        const downloadUrl = `https://www.googleapis.com/drive/v3/files/${latestFile.id}?alt=media&key=${driveConfig.apiKey}`;
        const content = await (await fetch(downloadUrl)).text();

        currentFile = { name: latestFile.name, size: content.length, lastModified: new Date(latestFile.modifiedTime).getTime() };
        fileName.textContent = currentFile.name;
        fileDetails.textContent = `Tamanho: ${(currentFile.size/1024).toFixed(2)} KB`;
        fileInfo.style.display = 'block';

        processLogContent(content);
        updateFileStatus(true);
    } catch (err) {
        console.error(err);
        addLog('‚ùå Erro: ' + err.message);
        updateFileStatus(false);
    } finally {
        driveBtn.disabled = false;
        driveBtn.textContent = '‚òÅÔ∏è Carregar do Google Drive';
    }
}

    </script>
</body>
</html>
